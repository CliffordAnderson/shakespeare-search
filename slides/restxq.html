<html>
    <head>
        <meta charset="utf-8"/>
        <title>RESTful XQuery</title>
        <meta name="description" content="RESTful XQuery"/>
        <meta name="author" content="Kevin S. Clarke"/>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <link rel="stylesheet" href="$root/resources/css/reveal.css"/>
        <link rel="stylesheet" href="$root/resources/css/zenburn.css"/>
        <link rel="stylesheet" href="$root/resources/css/theme/xqi.css" id="theme"/>
        <script>
        if (window.location.search.match(/print-pdf/gi)) {
		    var link = document.createElement('link');
		    link.rel = 'stylesheet';
		    link.type = 'text/css';
		    link.href = '$root/resources/css/print/pdf.css';
		    document.getElementsByTagName('head')[0].appendChild(link);
	    }
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>REST<span style="font-size: smaller;">ful</span> XQuery</h1>
                    <aside class="notes">
                        <p>Not about the language or a systems-view as much as an application view</p>
                        <p>"How do I make this need technology work with other neat technologies?"</p>
                        <p>REST libraries in other languages + other toolkits (angularjs, etc.)</p>
                    </aside>
                </section>
                <section>
                    <h1>REST</h1>
                    <br/>
                    <h2>(RE)presentational (S)tate (T)ransfer</h2>
                    <aside class="notes">
                        <p>An architectural style first expressed by Roy Fielding in his PhD dissertation.</p>
                        <p>Used by many to describe the desired architecture for the World Wide Web.</p>
                        <p>Fielding used REST to design HTTP 1.1 and Uniform Resource Identifiers (URIs).</p>
                        <p>Representations of resources whose state is updated, delivered, etc. via HTTP actions at URIs</p>
                    </aside>
                </section>
                <section>
                    <h2>The Context</h2>
                    <br/>
                    <ul style="list-style-type:none; margin: 10px;">
                        <li style="padding: 10px;">XML-RPC</li>
                        <li style="padding: 10px;">SOAP</li>
                        <li style="padding: 10px;">Corba</li>
                    </ul>
                </section>
                <section>
                    <h2>REST's Advantages</h2>
                    <br/>
                    <ul>
                        <li style="padding: 10px;">Simple Interfaces</li>
                        <li style="padding: 10px;">Visible Communications</li>
                        <li style="padding: 10px;">Stateless</li>
                        <li style="padding: 10px;">Cacheable</li>
                        <li style="padding: 10px;">Layered</li>
                        <li style="padding: 10px;">Code on Demand (optional)</li>
                    </ul>
                </section>
                <section>
                    <h2>REST in eXist-db Web Services</h2>
                    <br/>
                    <ul style="list-style-type:none; margin: 10px;">
                        <li style="padding: 10px;">GET</li>
                        <li style="padding: 10px;">DELETE</li>
                        <li style="padding: 10px;">PUT</li>
                        <li style="padding: 10px;">POST</li>
                    </ul>
                    <aside class="notes">
                        <p>RESTful interface provided out of the box with eXist.</p>
                        <p>You don't have to do anything to take advantage of it.</p>
                    </aside>
                </section>
                <section>
                    <h2>GET</h2>
                    <br/>
                    <p>With optional HTTP parameters</p>
                    <ul style="list-style-type:none; margin: 10px;">
                        <li style="padding: 10px;">_query</li>
                        <li style="padding: 10px;">_xsl</li>
                    </ul>
                    <aside class="notes">
                        <p>Example: Getting an XML list of plays from the 'plays' directory.</p>
                        <p>Retrieves a representation of the resource or collection from the database. XQuery and XPath queries may also be specified using GET's optional parameters applied to the selected resource.</p>
                        <p>Demonstrate pragmatic uses of "_query=" and "_xsl=" parameters.</p>
                        <p>http://localhost:8080/exist/rest/apps/xq-institute/data/plays/H8.xml?_query=//*:titleStmt</p>
                        <p>Example: http://localhost:8080/exist/rest/apps/xq-institute/data/plays/H8.xml?_xsl=../../resources/xsl/teiHTML.xsl</p>
                    </aside>
                </section>
                <section>
                    <h2>DELETE</h2>
                    <aside class="notes">
                        <p>Example: Deleting a play from the 'plays' directory.</p>
                        <p>Removes a resource (document or collection) from the database.</p>
                        <p>DELETE: http://localhost:8080/exist/rest/apps/xq-institute/data/plays/H8.xml</p>
                        <p>Afterwards check: http://localhost:8080/exist/apps/xq-institute/data/plays</p>
                    </aside>
                </section>
                <section>
                    <h2>PUT</h2>
                    <aside class="notes">
                        <p>Example: PUT a play into the 'plays' directory.</p>
                        <p>Uploads a resource onto the database. If required, collections are automatically created, and existing resources are overwritten.</p>
                        <p>PUT: http://localhost:8080/exist/rest/apps/xq-institute/data/plays/H8.xml</p>
                        <p>Afterwards check: http://localhost:8080/exist/apps/xq-institute/data/plays</p>
                    </aside>
                </section>
                <section>
                    <h2>POST</h2>
                    <ul style="list-style-type:none; margin: 10px;">
                        <li style="padding: 10px;">XQuery</li>
                        <li style="padding: 10px;">XUpdate</li>
                    </ul>
                    <aside class="notes">
                        <p>Example: POST a play into the 'plays' directory.</p>
                        <p>Submits data in the form of an XML fragment in the content of the request which specifies the action to take. The fragment can be either an XUpdate document or a query request. Query requests are used to pass complex XQuery expressions too large to be URL-encoded.</p>
                        <p>Example: An XQuery script</p>
                    </aside>
                </section>
                <section>
                    <h2>Stored XQueries</h2>
                    <br/>
                    <p>
                        <a target="_blank" href="http://localhost:8080/exist/rest/apps/xq-institute/modules/demo.xql">(demo)</a>
                    </p>
                </section>
                <section>
                    <h2>RESTXQ</h2>
                    <br/>
                    <p>Annotations</p>
                    <aside class="notes">
                        <p>XQuery 3.0 adds annotations: %public and %private (and says implementations can define more that are implementation specific)</p>
                        <p>Adam Retter, an eXist-db developer, looked at JSR-311: Java Annotations for REST and envisioned something like them for XQuery</p>
                        <p>"Metaprogramming"</p>
                    </aside>
                </section>
                <section>
                    <h2>Configuring RESTXQ</h2>
                    <pre class="stretch">
                        <code class="htmltemplate">
 &lt;triggers&gt;
  &lt;trigger class=
   "org.exist.extensions.exquery.restxq.impl.RestXqTrigger"
  /&gt;
 &lt;/triggers&gt;
 
</code>
                    </pre>
                    <p>(May already be configured)</p>
                    <aside class="notes">
                        <p>XQuery and Java implementations exist</p>
                        <p>XQuery version can hook into controller</p>
                        <p>Java version will replace the XQuery version (and eventually the controller too)</p>
                    </aside>
                </section>
                <section>
                    <h2>The Basics</h2>
                    <br/>
                    <ul>
                        <li>
                            <span class="green">%rest</span>:<span class="purple">GET</span>
                        </li>
                        <li>
                            <span class="green">%rest</span>:<span class="purple">path()</span>
                        </li>
                        <li>
                            <span class="green">%output</span>:<span class="purple">media-type()</span>
                        </li>
                        <li>
                            <span class="green">%output</span>:<span class="purple">method()</span>
                        </li>
                    </ul>
                    <br/>
                    <br/>
                    <br/>
                    <br/>
                    <p style="font-size: 60%">
                        <a href="http://exquery.github.io/exquery/exquery-restxq-specification/restxq-1.0-specification.html">http://exquery.github.io/exquery/exquery-restxq-specification/restxq-1.0-specification.html</a>
                    </p>
                    <p style="font-size: 60%; padding-top: 10px;">
                        <a href="http://www.w3.org/2010/xslt-xquery-serialization">http://www.w3.org/2010/xslt-xquery-serialization</a>
                    </p>
                </section>
                <section>
                    <h2>A Basic Example</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
     %rest:GET
     %rest:path("/shakespeare/plays")
     %output:media-type("text/html")
     %output:method("html5")
 function demo:get-plays-html() {
     demo:htmlify(demo:list-plays())
 };

</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/plays">Try it</a> )</p>
                </section>
                <section>
                    <h2>Example's Code</h2>
                    <pre class="stretch">
                        <code>
 declare
   %private
 function demo:list-plays() as element(plays) {
   &lt;plays&gt;{
     for $play
       in collection('/db/apps/xq-institute/data/plays')
     return 
       &lt;play&gt;
         &lt;id&gt;{
           $play//tei:publicationStmt/tei:idno/text()
         }&lt;/id&gt;
         &lt;title&gt;{
           $play//tei:titleStmt/tei:title/text()
         }&lt;/title&gt;
         &lt;author&gt;{
           $play//tei:titleStmt/tei:author/text()
         }&lt;/author&gt;
         &lt;updateDate&gt;{
           $play//tei:publicationStmt/tei:date/text()
         }&lt;/updateDate&gt;
       &lt;/play&gt;
   }&lt;/plays&gt;
 };

 declare
   %private
 function demo:htmlify($plays as element(plays))
     as element(html) {
   &lt;html&gt;
     &lt;head&gt;
       &lt;title&gt;Simple List of Plays&lt;/title&gt;
     &lt;/head&gt;
     &lt;body&gt;
       &lt;p style="padding: 15px;"&gt;
         &lt;table width="33%"&gt;
           &lt;tr&gt;
             &lt;th style="text-align:left"&gt;Title&lt;/th&gt;
             &lt;th style="text-align:left"&gt;Author&lt;/th&gt;
           &lt;/tr&gt;
           {
             for $play in $plays/play
             return 
               &lt;tr&gt;
                 &lt;td&gt;{$play/title/text()}&lt;/td&gt;
                 &lt;td&gt;{$play/author/text()}&lt;/td&gt;
               &lt;/tr&gt;
           }
         &lt;/table&gt;
       &lt;/p&gt;
     &lt;/body&gt;
   &lt;/html&gt;
 };

</code>
                    </pre>
                </section>
                <section>
                    <h2>With JSON Output</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
     %rest:GET
     %rest:path("/shakespeare/plays/json")
     %output:media-type("application/json")
     %output:method("json")
 function demo:get-plays-json() {
     demo:list-plays()
 };
 
</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/plays/json">Try it</a> )</p>
                </section>
                <section>
                    <h2>With Atom Output</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
     %rest:GET
     %rest:path("/shakespeare/plays/atom")
     %output:media-type("application/atom+xml")
     %output:method("xml")
 function demo:get-plays-atom() {
     demo:atomify(demo:list-plays())
 };

</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/plays/atom">Try it</a> )</p>
                </section>
                <section>
                    <h2>Atom Feed's Code</h2>
                    <pre class="stretch">
                        <code>
 declare
   %private
 function demo:list-plays() as element(plays) {
   &lt;plays&gt;{
     for $play in collection(
       '/db/apps/xq-institute/data/plays')
     return 
       &lt;play&gt;
         &lt;id&gt;{
           $play//tei:publicationStmt/tei:idno/text()
         }&lt;/id&gt;
         &lt;title&gt;{
           $play//tei:titleStmt/tei:title/text()
         }&lt;/title&gt;
         &lt;author&gt;{
           $play//tei:titleStmt/tei:author/text()
         }&lt;/author&gt;
         &lt;updateDate&gt;{
           $play//tei:publicationStmt/tei:date/text()
         }&lt;/updateDate&gt;
       &lt;/play&gt;
   }&lt;/plays&gt;
 };

 declare
   %private
 function demo:atomify($plays as element(plays))
     as element(feed) {
   let $server :=
     'http://localhost:8080/exist/restxq/shakespeare'
   return
     &lt;atom:feed
         xmlns:atom="http://www.w3.org/2005/Atom"&gt;
       &lt;atom:id&gt;{$server}/plays/atom&lt;/atom:id&gt;
       &lt;atom:title&gt;Example Atom Feed&lt;/atom:title&gt;
       &lt;atom:link rel="self"
         href="{$server}/plays/atom"/&gt;
       &lt;atom:updated&gt;{
         current-dateTime()
       }&lt;/atom:updated&gt;
       {
       (:
         Update dates aren't in the right format,
         but we'll pretend they are..
       :)
       for $play in $plays/play
       let $id := $play/id/text()
       return
         &lt;atom:entry&gt;
         &lt;atom:title&gt;{
           $play/title/text()
         }&lt;/atom:title&gt;
         &lt;atom:author&gt;
           &lt;atom:name&gt;{
             $play/author/text()
           }&lt;/atom:name&gt;
         &lt;/atom:author&gt;
         &lt;atom:link href="{$server}/play/{$id}"/&gt;
         &lt;atom:id&gt;{$server}/play/{$id}&lt;/atom:id&gt;
         &lt;atom:updated&gt;{
           $play/updateDate/text()
         }&lt;/atom:updated&gt;
         &lt;/atom:entry&gt;
       }
     &lt;/atom:feed&gt;
};

</code>
                    </pre>
                </section>
                <section>
                    <h2>With Variables</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:GET
   %rest:path("/shakespeare/play/{$id}")
   %output:media-type("text/html")
   %output:method("html5")
 function demo:get-play($id as xs:string) {
   let $root :=
     doc('../data/plays/' || $id || '.xml')
   return
     &lt;html&gt;
       &lt;head&gt;
         &lt;title&gt;{
           $root//tei:titleStmt/tei:title/text()
         }&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;{
         transform:transform($root,
         doc('../resources/xsl/teiHTML.xsl'), ())
       }&lt;/body&gt;
     &lt;/html&gt;
 };

</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/play/MND">Try it</a> )</p>
                </section>
                <section>
                    <h2>With Parameters</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:GET
   %rest:path("/shakespeare/play")
   %rest:query-param("id", "{$id}")
   %output:media-type("text/html")
   %output:method("html5")
 function demo:get-play-by($id as xs:string*) {
   let $root :=
     doc('../data/plays/' || $id || '.xml')
   return
     &lt;html&gt;
       &lt;head&gt;
         &lt;title&gt;{
           $root//tei:titleStmt/tei:title/text()
         }&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;{
         transform:transform($root,
         doc('../resources/xsl/teiHTML.xsl'), ())
       }&lt;/body&gt;
     &lt;/html&gt;
 };

</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/play?id=MND">Try it</a> )</p>
                </section>
                <section>
                    <h2>Default Parameters</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:GET
   %rest:path("/shakespeare/play")
   %rest:query-param("id", "{$id}", "H8")
   %output:media-type("text/html")
   %output:method("html5")
 function demo:get-play-by($id as xs:string+) {
   let $root :=
     doc('../data/plays/' || $id || '.xml')
   return
     &lt;html&gt;
       &lt;head&gt;
         &lt;title&gt;{
           $root//tei:titleStmt/tei:title/text()
         }&lt;/title&gt;
       &lt;/head&gt;
       &lt;body&gt;{
         transform:transform($root,
         doc('../resources/xsl/teiHTML.xsl'), ())
       }&lt;/body&gt;
     &lt;/html&gt;
 };

</code>
                    </pre>
                    <p>( <a target="_blank" href="http://localhost:8080/exist/restxq/shakespeare/play">Try it</a> )</p>
                </section>
                <section>
                    <h2>And...</h2>
                    <br/>
                    <ul>
                        <li style="padding-bottom: 20px;">%rest:form-param("parameter", "{$value}")<br/>
                            <span style="font-size: 80%;">&#160;&#160;[application/x-www-form-urlencoded]</span>
                        </li>
                        <li style="padding-bottom: 20px;">%rest:header-param("User-Agent", "{$user-agent}")</li>
                        <li style="padding-bottom: 20px;">%rest:cookie-param("username", "{$user}")</li>
                    </ul>
                    <br/>
                    <br/>
                    <p>(+ default values as a third argument)</p>
                </section>
                <section>
                    <h2>RESTXQ DELETE</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:DELETE
   %rest:path("/shakespeare/plays/delete/{$id}")
   %output:media-type("text/txt")
   %output:method("text")
 function demo:delete-play($id as xs:string) {
   if (exists(
     doc('/db/apps/xq-institute/data/plays/'
     || $id || '.xml')
   ))
   then (
     xmldb:remove('/db/apps/xq-institute/data/plays',
       $id || '.xml'),
     if (exists(
       doc('/db/apps/xq-institute/data/plays/'
       || $id || '.xml')
     ))
     then demo:respond(500,
       'Item was not successfully deleted')
     else demo:respond(200,
       'Item was successfully deleted')
   )
   else demo:respond(404,
     'Item to be deleted did not exist!')
 };

 declare
   %private
 function demo:respond($code as xs:int,
     $message as xs:string) {
   (
   &lt;rest:response&gt;
     &lt;http:response status="{$code}"/&gt;
   &lt;/rest:response&gt;, 
   $message
   )
 };

</code>
                    </pre>
                    <p style="font-size: 75%;">(Postman client demo)</p>
                </section>
                <section>
                    <h2>RESTXQ PUT</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:PUT("{$data}")
   %rest:path("/shakespeare/plays/add/{$id}")
   %output:media-type("text/txt")
   %output:method("text")
 function demo:put-play($id as xs:string,
     $data as node()) {
   if (not(exists(
     doc('/db/apps/xq-institute/data/plays/'
     || $id || '.xml'))
   ))
   then (
     let $item :=
       xmldb:store('/db/apps/xq-institute/data/plays',
       $id || '.xml', $data)
     return (),
     if (exists(
       doc('/db/apps/xq-institute/data/plays/'
       || $id || '.xml')
     ))
     then demo:respond(201,
       'Item successfully created on the server')
     else demo:respond(500,
       'Item failed to be created on the server')
   )
   else demo:respond(409,
     "Item already exists! Use POST to update it.")
 };

 declare
   %private
 function demo:respond($code as xs:int,
     $message as xs:string) {
   (
     &lt;rest:response&gt;
       &lt;http:response status="{$code}"/&gt;
     &lt;/rest:response&gt;, 
     $message
   )
 };

</code>
                    </pre>
                    <p style="font-size: 75%;">(Postman client demo)</p>
                </section>
                <section>
                    <h2>RESTXQ POST</h2>
                    <pre class="stretch">
                        <code class="javascript">
 declare
   %rest:POST('{$data}')
   %rest:path('/shakespeare/plays/update/{$id}')
   %output:media-type('text/txt')
   %output:method('text')
 function demo:post-play($id as xs:string,
     $data as item()) {
   if (exists(
     doc('/db/apps/xq-institute/data/plays/'
     || $id || '.xml')
   ))
   then
     update insert
       &lt;tei:change
         who='http://xqueryinstitute.org/{$data}'
         when='{current-dateTime()}'
       &gt;Change made via POST.&lt;/tei:change&gt;
     into
       doc('/db/apps/xq-institute/data/plays/'
       || $id || '.xml')//tei:revisionDesc
   else demo:respond(404,
     'Unable to find item to update.')
 };

 declare
   %private
 function demo:respond($code as xs:int,
     $message as xs:string) {
   (
     &lt;rest:response&gt;
       &lt;http:response status="{$code}"/&gt;
     &lt;/rest:response&gt;, 
     $message
   )
 };

</code>
                    </pre>
                    <p style="font-size: 75%;">(Postman client demo)</p>
                </section>
                <section>
                    <h2>Content Negotiation</h2>
                    <br/>
                    <ul>
                        <li style="padding-bottom: 20px;">%rest:consumes("application/xml", "text/xml")</li>
                        <li style="padding-bottom: 20px;">%rest:produces("application/atom+xml")</li>
                    </ul>
                </section>
                <section>
                    <h2>Useful Links</h2>
                    <br/>
                    <ul>
                        <li>
                            <a href="http://exist-db.org/exist/apps/doc/devguide_rest.xml">eXist-db Dev Guide: REST</a>
                        </li>
                        <li>
                            <a href="http://docs.basex.org/wiki/RESTXQ">BaseX RESTXQ Documentation</a>
                        </li>
                        <li>
                            <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP Status Codes</a>
                        </li>
                    </ul>
                </section>
            </div>
        </div>
        <script src="$root/resources/js/head.min.js"/>
        <script src="$root/resources/js/reveal.js"/>
        <script>
        // https://github.com/hakimel/reveal.js#configuration (w/h was 960 x 700)
	    Reveal.initialize({
	        controls: true,
	        progress: false,
	        history: true,
            keyboard: true,
            center: true,
            width: 1024,
            height: 764,
		theme: Reveal.getQueryHash().theme,
		transition: Reveal.getQueryHash().transition || 'default',
		dependencies: [
			{ src: '$root/resources/js/classList.js',
			    condition: function() { return !document.body.classList; }},
			{ src: '$root/resources/js/highlight/highlight.js', async: true,
			    callback: function() { hljs.initHighlightingOnLoad(); }}
		]});
        </script>
    </body>
</html>